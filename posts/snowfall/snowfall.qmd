---
title: '<span class="humans-learning-post">Snowfall at Alta, UT</span>'
subtitle: "Visualizing snowfall data using Plotly"
categories: [R, plotly]
date: "2025-11-11"
author: "Brian Calhoon"
title-block-banner: "#C9C9C9"
image: "snow_monthly.png" 
format: 
  html:
    code-fold: false
    code-summary: "Show the code"
    toc: true
    css: styles.css
editor: visual
execute:
  message: false
  warning: false
filters: 
  - webr
---

```{r global_options, include=F, warning=F, message=F, error=F}


```

# Why am I here?        `r fontawesome::fa("earlybirds", fill = "#FFB947", height = '2em', width = '2em')`

:::: box
::: box-header
I was talking with a friend recently about when I should visit Utah for skiing this year. He sent me a link to the [Utah Avalanche Center](https://utahavalanchecenter.org/alta-monthly-snowfall) to look at monthly precipitation data for the [Alta Guard Station](https://utahavalanchecenter.org/alta-monthly-snowfall). I'll use this data to guide my trip planning. For learning purposes, this post will demonstrate how to download, clean, and visualize data using Plotly to create an interactive plot.  Enjoy!
:::
::::

# Learning objectives

For this session, the learning objective is to:

-   download a file from a website

-   shape and clean the data for visualization

-   visualize the data using [Plotly](https://plotly.com/r/)

As always, let's make sure that our libraries are loaded and if any need to be installed that you run `install.packages()` line first.

```{r}

#install.packages(c("plotly", "tidyverse", "readxl"))

library(plotly)
library(tidyverse)
library(readxl)
```

## Download the data

Monthly snowfall data for the Alta Guard Station is available at the bottom of the this page, https://utahavalanchecenter.org/alta-monthly-snowfall. 

Copy the link to the .xlsx file and follow the script below.

```{r}
#| class-output: pre


# Download and read the data
data_url <- "https://utahavalanchecenter.org/sites/default/files/attached_files/2025.05.01%20Alta%20Guard%20Snow%3AWater.xlsx"

# Download the file
download.file(data_url, destfile = here::here("posts/snowfall/alta_data.xlsx"), mode = "wb")

#assign it to an object
df <- readxl::read_xlsx("alta_data.xlsx")

#view the data
glimpse(df)

```
## Shape and clean the data

The data has `{r} paste0(nrow(df), " rows and ", ncol(df), " columns")`. In looking at the data, it's clear that the first 6 rows provide a summary of the data rather than the data itself. So, let's drop those rows.

We'll use a basic subsetting approach. Within the brackets `[]`, the code before the "," `7:nrow(df)` are for rows, and after the comma come the columns. We want to take everything starting from row 7, and we select all the columns by leaving that part blank.

```{r}

#assign it a new object name 
# so we don't lose data

df1 <- df[7:nrow(df),]
```

Due in part to the summary data near the top of the file, the columns also need to be renamed, too. Each month has a column for snow and rain. To make for an easier pivot later, we'll add the prefix "month_" to each rain or snow column.

```{r}
#| class-output: pre

names(df1) <- c("season",
                "nino",
                "oct_snow",
                "oct_rain",
                "nov_snow",
                "nov_rain",
                "dec_snow",
                "dec_rain",
                "jan_snow",
                "jan_rain",
                "feb_snow",
                "feb_rain",
                "march_snow",
                "march_rain",
                "april_snow",
                "april_rain",
                "may_snow",
                "may_rain",
                "blank",
                "total_snow",
                "total_rain",
                "blank2",
                "blank3")

glimpse(df1)
```

Now it is beginning to take shape. There are two extra columns on the end where someone did some calculations, and a blank column before the total columns. Notice, we named those with the word "blank". Let's drop those and drop the columns that total the rain and snow fall.

```{r}
#remove last two columns that have some
# undefined numbers
#also remove the total snow and rain columns
df2 <- df1 |> 
  select(-20:-23, -blank)

```

Now we have a wide dataset that we want to make longer. For visualizing with ggplot, we want all the snow or rain data in a single column and the months in a single column. This is easily done with tidyr's `pivot_longer()` function.

For the pivotting, we select columns 3 thru 18 with the `cols` argument. 

We will move the names of the columns to a column called "month" and a column called "type". Because we know that each name is separated by a `_` we can separate the columns into these two new columns using the `_` as a separator. The month prefix will go to the "month" column and the "rain" or "snow" suffix will go to the "type" column.

The values will be placed in a new column called "amount". Now, run the code.

```{r}
#| class-output: pre

df3 <- df2 |> 
  pivot_longer(cols = 3:18,
               names_to = c("month", "type"),
               names_sep = "_",
               values_to = "amount")


glimpse(df3)
```

The new dataframe, `df3` is much longer, indeed. We now have `{r} paste0(nrow(df3), " rows and ", ncol(df3), " columns")`. These 5 columns each contain a single data type that we can easily use for analysis after we clean up a few more things.

Change the "N" in the nino column to "Neutral" and make the months start with uppercase letters in the month column.

```{r}

#recode the N response in nino column
df3$nino <- df3$nino |> 
  recode("N" = "Neutral")

#recode the months
df3$month <- df3$month |> 
  recode("oct" = "Oct",
         "nov" = "Nov",
         "dec" = "Dec",
         "jan" = "Jan",
         "feb" = "Feb",
         "march" = "March",
         "april" = "April",
         "may" = "May")
```

Finally, we want to remove the rain data, make sure the `type` column is numeric, remove rows of missing data, and ensure that our factor data has an order. Factor data is categorical data. We want it to be clear to R that these are not just words but categories.

To do this last part, we will use  `factor()` on the month and nino columns and then define the `levels` or order that we want to be recognized for the months and for the strength of el nino or la nina.



```{r}
#| class-output: pre

#now we can look at just the snowfall
df3_snow <- df3 |> 
  filter(type == "snow") |> #remove rows with rain
  mutate(amount = as.numeric(amount)) |> #convert amount to numeric
  filter(!is.na(amount)) |> #remove missing amounts
  #Set factor levels for months
  mutate(month = factor(month, 
                        levels = c("Oct", "Nov", "Dec", "Jan", "Feb", 
                                   "March", "April", "May")),
         month_num = as.numeric(month),
         #Set factor levels for nino
         nino = factor(nino,
                       levels = c("La Nina Strong",
                                  "La Nina Mod",
                                  "La Nina Weak",
                                  "Neutral",
                                  "El Nino Weak",
                                  "El Nino Mod",
                                  "El Nino Strong",
                                  "El Nino Very Strong"))) |> 
  #provide a numeric value for nino as well in a new column
  mutate(nino_numeric = case_when(
    nino == "La Nina Strong" ~ -3,
    nino == "La Nina Mod" ~ -2,
    nino == "La Nina Weak" ~ -1,
    nino == "Neutral" ~ 0,
    nino == "El Nino Weak" ~ 1,
    nino == "El Nino Mod" ~ 2,
    nino == "El Nino Strong" ~ 3,
    nino == "El Nino Very Strong" ~ 4,
    TRUE ~ NA_real_
  ))

glimpse(df3_snow)
```

Look at the data types in the nino, month, and amount columns. We also added a numeric column for nino. This is useful when visualizing for smoothing lines or using continuous color scales.



## Visualize the data

Let's take a look at what we've got.

```{r}
ggplot(df3_snow) +
  geom_point(aes(x = month,
                 y = amount)) +
  theme_minimal()

```
We've got the usual months for snowfall,and we've got lots of points. It's a little hard to see where they all land, but we can start to make out that from November through March Alta generally has good snowfall. Let's add some jitter to see the points more clearly, improve labels, and give it some color.

Then, let's add a smoothing line using `geom_smooth()`. This line will help us more easily identify the middle of a noisy dataset.

::: {.callout-tip}
## Understanding `geom_smooth()`

The `geom_smooth()` function in ggplot2 adds a smoothed conditional mean line to your plot, helping visualize trends in noisy data. By default, it uses LOESS smoothing for datasets with fewer than 1,000 observations and generalized additive models (GAM) for larger datasets. 

Common parameters include:
- `method` - specify the smoothing method (e.g., "lm" for linear, "loess", "gam")
- `se` - whether to display confidence interval (default is TRUE)
- `span` - controls LOESS smoothness (0-1, where smaller = wigglier)
- `formula` - for custom model formulas like `y ~ poly(x, 2)` for polynomial fits

Example: `geom_smooth(method = "lm", se = TRUE)` adds a linear regression line with 95% confidence bands.
:::

```{r}
plot <- ggplot(df3_snow) +
  geom_jitter(aes(x = month_num,
                 y = amount),
              fill = "blue",
              shape = 21,
              color = "white",
              alpha = .8,
              width = .25,
              size = 4) +
  geom_smooth(aes(x = month_num, y = amount), color = "red", se = FALSE) +
  scale_x_continuous(breaks = 1:8, 
                     labels = levels(df3_snow$month)) +
  labs(x = "Months",
       y = "Amount of \nSnowfall (in.)",
       title = "Monthly Snowfall at Alta",
       subtitle = "Alta gets a lot of snow, particularly from November through March",
       caption = "Source: Utah Avalanche Center, https://utahavalanchecenter.org/alta-monthly-snowfall") +
  theme_minimal()

plot

```

Using Plotly from R is pretty easy with an existing ggplot object. We've already defined our ggplot object as `plot` above. We can simply pass this to plotly and we get an interactive data visualization. Pretty cool! 

```{r}

ggplotly(plot)
```


The tooltip that pops up is not that useful out of the box. So, let's provide an additional parameter to `geom_jitter()` called `text`, and then tell plotly to use that for the tooltip.

The new `text` parameter will pull data from the season, month, amount, and nino columns and combine it using `paste0()`.

The main glitch with plotly is that it doesn't handle the subtitle and caption from ggplot. I'm not sure why, but I added that in separately. Another option is to just add these as text directly in the .qmd file that generates the final output.

```{r}
plot <- ggplot(df3_snow) +
  geom_jitter(aes(x = month_num,
                 y = amount,
                 text = paste0("Season: ", season,
                                "\nMonth: ", month,
                                "\nSnowfall: ", round(amount, 1), " in.",
                                "\nENSO: ", nino)),
              fill = "blue",
              shape = 21,
              color = "white",
              alpha = .8,
              width = .25,
              size = 4) +
  geom_smooth(aes(x = month_num, y = amount), color = "red", se = FALSE) +
  scale_x_continuous(breaks = 1:8, 
                     labels = levels(df3_snow$month)) +
  labs(x = "Months",
       y = "Amount of \nSnowfall (in.)",
       title = "Monthly Snowfall at Alta",
       subtitle = "Alta gets a lot of snow, particularly from November through March",
       caption = "Source: Utah Avalanche Center, https://utahavalanchecenter.org/alta-monthly-snowfall") +
  theme_minimal()

plot_ly <- ggplotly(plot, tooltip = "text")

plot_ly_cap <- plot_ly |> 
  layout(annotations = list(
    #subtitle
    list(x = 0,
        y = 1.08,
        text = "Alta gets a lot of snow, particularly from November through March",
        xref = "paper",
        yref = "paper",
        xanchor = "left",
        showarrow = FALSE,
        font = list(size = 12, color = "gray30")
      ),
    #caption
    list(
        x = 1,
        y = -0.25,
        text = "Source: Utah Avalanche Center, https://utahavalanchecenter.org/alta-monthly-snowfall",
        xref = "paper",
        yref = "paper",
        xanchor = "right",
        showarrow = FALSE,
        font = list(size = 9, color = "gray50")
      )
    ),
    margin = list(t = 80, b = 100)
  )

plot_ly_cap
```

## Conclusion

Now we have a basic interactive graphic that leverages plotly. If you can ggplot, then you can ggplotly. 

Additional posts using this same dataset will delve into the smoothing lines and then make predictions for future monthly snowfall.